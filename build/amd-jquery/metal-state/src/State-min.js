define(["exports","metal/src/metal","metal-events/src/events"],function(t,e,i){"use strict";function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(t){function i(e,o,s,r){a(this,i);var c=n(this,t.call(this));return c.commonOpts_=r,c.context_=s||c,c.keysBlacklist_={},c.obj_=o||c,c.scheduledBatchData_=null,c.stateInfo_={},c.setShouldUseFacade(!0),c.mergeInvalidKeys_(),c.addToStateFromStaticHint_(e),c}return o(i,t),i.prototype.addKeyToState=function(t,e,i){this.buildKeyInfo_(t,e,i,arguments.length>2),Object.defineProperty(this.obj_,t,this.buildKeyPropertyDef_(t)),this.validateInitialValue_(t),this.assertGivenIfRequired_(t)},i.prototype.addToState=function(t,i,a){if(e.core.isString(t))return this.addKeyToState.apply(this,arguments);for(var n=i||{},o=Object.keys(t),s={},r=0;r<o.length;r++){var c=o[r];this.buildKeyInfo_(c,t[c],n[c],n.hasOwnProperty(c)),s[c]=this.buildKeyPropertyDef_(c,a),this.assertGivenIfRequired_(c)}a!==!1&&Object.defineProperties(a||this.obj_,s);for(var l=0;l<o.length;l++)this.validateInitialValue_(o[l])},i.prototype.addToStateFromStaticHint_=function(t){var e,a=this.constructor,n=i.mergeStateStatic(a);this.obj_===this&&(e=!!n&&a.prototype),this.addToState(a.STATE_MERGED,t,e)},i.prototype.assertGivenIfRequired_=function(t){var a=this.stateInfo_[t];if(a.config.required){var n=a.state===i.KeyStates.INITIALIZED?this.get(t):a.initialValue;!e.core.isDefAndNotNull(n)}},i.prototype.assertValidStateKeyName_=function(t){if(this.constructor.INVALID_KEYS_MERGED[t]||this.keysBlacklist_[t])throw new Error("It's not allowed to create a state key with the name \""+t+'".')},i.prototype.buildKeyInfo_=function(t,a,n,o){this.assertValidStateKeyName_(t),a=a&&a.config?a.config:a||{},this.commonOpts_&&(a=e.object.mixin({},a,this.commonOpts_)),this.stateInfo_[t]={config:a,state:i.KeyStates.UNINITIALIZED},o&&(this.stateInfo_[t].initialValue=n)},i.prototype.buildKeyPropertyDef_=function(t,e){var i=e===this.constructor.prototype?null:this;return{configurable:!0,enumerable:!0,get:function(){return(i||this).getStateKeyValue_(t)},set:function(e){(i||this).setStateKeyValue_(t,e)}}},i.prototype.callFunction_=function(t,i){return e.core.isString(t)?this.context_[t].apply(this.context_,i):e.core.isFunction(t)?t.apply(this.context_,i):void 0},i.prototype.callSetter_=function(t,e,i){var a=this.stateInfo_[t],n=a.config;return n.setter&&(e=this.callFunction_(n.setter,[e,i])),e},i.prototype.callValidator_=function(t,e){var i=this.stateInfo_[t],a=i.config;if(a.validator){var n=this.callFunction_(a.validator,[e,t,this.context_]);return n instanceof Error,n}return!0},i.prototype.canSetState=function(t){var e=this.stateInfo_[t];return!e.config.writeOnce||!e.written},i.prototype.disposeInternal=function(){t.prototype.disposeInternal.call(this),this.stateInfo_=null,this.scheduledBatchData_=null},i.prototype.emitBatchEvent_=function(){if(!this.isDisposed()){var t=this.scheduledBatchData_;this.scheduledBatchData_=null,this.emit("stateChanged",t)}},i.prototype.get=function(t){return this.obj_[t]},i.prototype.getState=function(t){for(var e={},i=t||this.getStateKeys(),a=0;a<i.length;a++)e[i[a]]=this.get(i[a]);return e},i.prototype.getStateKeyConfig=function(t){return(this.stateInfo_[t]||{}).config},i.prototype.getStateKeys=function(){return this.stateInfo_?Object.keys(this.stateInfo_):[]},i.prototype.getStateKeyValue_=function(t){if(!this.warnIfDisposed_(t))return this.initStateKey_(t),this.stateInfo_[t].value},i.prototype.hasBeenSet=function(t){var e=this.stateInfo_[t];return e.state===i.KeyStates.INITIALIZED||this.hasInitialValue_(t)},i.prototype.hasInitialValue_=function(t){return this.stateInfo_[t].hasOwnProperty("initialValue")},i.prototype.hasStateKey=function(t){if(!this.warnIfDisposed_(t))return!!this.stateInfo_[t]},i.prototype.informChange_=function(t,e){if(this.shouldInformChange_(t,e)){var i={key:t,newVal:this.get(t),prevVal:e};this.emit(t+"Changed",i),this.emit("stateKeyChanged",i),this.scheduleBatchEvent_(i)}},i.prototype.initStateKey_=function(t){var e=this.stateInfo_[t];e.state===i.KeyStates.UNINITIALIZED&&(e.state=i.KeyStates.INITIALIZING,this.setInitialValue_(t),e.written||this.setDefaultValue(t),e.state=i.KeyStates.INITIALIZED)},i.mergeState=function(t){return e.object.mixin.apply(null,[{}].concat(t.reverse()))},i.mergeStateStatic=function(t){return e.core.mergeSuperClassesProperty(t,"STATE",i.mergeState)},i.prototype.mergeInvalidKeys_=function(){e.core.mergeSuperClassesProperty(this.constructor,"INVALID_KEYS",function(t){return e.array.flatten(t).reduce(function(t,e){return e&&(t[e]=!0),t},{})})},i.prototype.removeStateKey=function(t){this.stateInfo_[t]=null,delete this.obj_[t]},i.prototype.scheduleBatchEvent_=function(t){this.scheduledBatchData_||(e.async.nextTick(this.emitBatchEvent_,this),this.scheduledBatchData_={changes:{}});var i=t.key,a=this.scheduledBatchData_.changes;a[i]?a[i].newVal=t.newVal:a[i]=t},i.prototype.set=function(t,e){this.hasStateKey(t)&&(this.obj_[t]=e)},i.prototype.setDefaultValue=function(t){var e=this.stateInfo_[t].config;void 0!==e.value?this.set(t,e.value):this.set(t,this.callFunction_(e.valueFn))},i.prototype.setInitialValue_=function(t){if(this.hasInitialValue_(t)){var e=this.stateInfo_[t];this.set(t,e.initialValue),e.initialValue=void 0}},i.prototype.setKeysBlacklist_=function(t){this.keysBlacklist_=t},i.prototype.setState=function(t,e){var i=this;Object.keys(t).forEach(function(e){return i.set(e,t[e])}),e&&this.scheduledBatchData_&&this.once("stateChanged",e)},i.prototype.setStateKeyValue_=function(t,e){if(!this.warnIfDisposed_(t)&&this.canSetState(t)&&this.validateKeyValue_(t,e)){var a=this.stateInfo_[t];this.hasInitialValue_(t)||a.state!==i.KeyStates.UNINITIALIZED||(a.state=i.KeyStates.INITIALIZED);var n=this.get(t);a.value=this.callSetter_(t,e,n),this.assertGivenIfRequired_(t),a.written=!0,this.informChange_(t,n)}},i.prototype.shouldInformChange_=function(t,a){var n=this.stateInfo_[t];return n.state===i.KeyStates.INITIALIZED&&(e.core.isObject(a)||a!==this.get(t))},i.prototype.validateInitialValue_=function(t){var e=this.stateInfo_[t];this.hasInitialValue_(t)&&!this.callValidator_(t,e.initialValue)&&delete e.initialValue},i.prototype.validateKeyValue_=function(t,e){var a=this.stateInfo_[t];return a.state===i.KeyStates.INITIALIZING||this.callValidator_(t,e)},i.prototype.warnIfDisposed_=function(t){var e=this.isDisposed();return e},i}(i.EventEmitter);s.INVALID_KEYS=["state","stateKey"],s.KeyStates={UNINITIALIZED:0,INITIALIZING:1,INITIALIZED:2},t["default"]=s});