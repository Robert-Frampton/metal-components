define(["exports","metal/src/metal","metal-dom/src/all/dom","./helpers/DragAutoScroll","./helpers/DragScrollDelta","./helpers/DragShim","metal-events/src/events","metal-position/src/all/position","metal-state/src/all/state"],function(e,t,i,o,r,a,n,s,l){"use strict";function c(e){return e&&e.__esModule?e:{"default":e}}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function d(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(e,"__esModule",{value:!0});var g=c(i),_=c(o),v=c(r),f=c(a),p=c(s),y=c(l),D=function(){function e(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,i,o){return i&&e(t.prototype,i),o&&e(t,o),t}}(),m=function b(e,t,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,t);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:b(r,t,i)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(i)},S=function(e){function i(e){u(this,i);var t=h(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return t.activeDragPlaceholder_=null,t.activeDragSource_=null,t.distanceDragged_=0,t.dragging_=!1,t.dragHandler_=new n.EventHandler,t.dragScrollDelta_=new v["default"],t.mousePos_=null,t.mouseSourceDelta_=null,t.sourceHandler_=new n.EventHandler,t.sourceRegion_=null,t.sourceRelativePos_=null,t.attachSourceEvents_(),t.on(i.Events.DRAG,t.defaultDragFn_,!0),t.on(i.Events.END,t.defaultEndFn_,!0),t.on("sourcesChanged",t.handleSourcesChanged_.bind(t)),t.on("containerChanged",t.handleContainerChanged_.bind(t)),t.dragScrollDelta_.on("scrollDelta",t.handleScrollDelta_.bind(t)),g["default"].on(document,"keydown",t.handleKeyDown_.bind(t)),t}return d(i,e),D(i,[{key:"attachSourceEvents_",value:function(){for(var e={keydown:this.handleSourceKeyDown_.bind(this),mousedown:this.handleDragStartEvent_.bind(this),touchstart:this.handleDragStartEvent_.bind(this)},i=Object.keys(e),o=0;o<i.length;o++){var r=e[i[o]];t.core.isString(this.sources)?this.sourceHandler_.add(g["default"].delegate(this.container,i[o],this.sources,r)):this.sourceHandler_.add(g["default"].on(this.sources,i[o],r))}}},{key:"buildEventObject_",value:function(){return{placeholder:this.activeDragPlaceholder_,source:this.activeDragSource_,relativeX:this.sourceRelativePos_.x,relativeY:this.sourceRelativePos_.y,x:this.sourceRegion_.left,y:this.sourceRegion_.top}}},{key:"calculateInitialPosition_",value:function(e){this.sourceRegion_=t.object.mixin({},p["default"].getRegion(this.activeDragSource_,!0)),this.sourceRelativePos_={x:this.activeDragSource_.offsetLeft,y:this.activeDragSource_.offsetTop},t.core.isDef(e.clientX)&&(this.mousePos_={x:e.clientX,y:e.clientY},this.mouseSourceDelta_={x:this.sourceRegion_.left-this.mousePos_.x,y:this.sourceRegion_.top-this.mousePos_.y})}},{key:"canStartDrag_",value:function(e){return!this.disabled&&(!t.core.isDef(e.button)||0===e.button)&&!this.isDragging()&&this.isWithinHandle_(e.target)}},{key:"cleanUpAfterDragging_",value:function(){this.activeDragPlaceholder_&&(this.activeDragPlaceholder_.setAttribute("aria-grabbed","false"),g["default"].removeClasses(this.activeDragPlaceholder_,this.draggingClass),this.dragPlaceholder===i.Placeholder.CLONE&&g["default"].exitDocument(this.activeDragPlaceholder_)),this.activeDragPlaceholder_=null,this.activeDragSource_=null,this.sourceRegion_=null,this.sourceRelativePos_=null,this.mousePos_=null,this.mouseSourceDelta_=null,this.dragging_=!1,this.dragHandler_.removeAllListeners()}},{key:"cloneActiveDrag_",value:function(){var e=this.activeDragSource_.cloneNode(!0);return e.style.position="absolute",e.style.left=this.sourceRelativePos_.x+"px",e.style.top=this.sourceRelativePos_.y+"px",g["default"].append(this.activeDragSource_.parentNode,e),e}},{key:"constrain_",value:function(e){this.constrainToAxis_(e),this.constrainToSteps_(e),this.constrainToRegion_(e)}},{key:"constrainToAxis_",value:function(e){"x"===this.axis?(e.top=this.sourceRegion_.top,e.bottom=this.sourceRegion_.bottom):"y"===this.axis&&(e.left=this.sourceRegion_.left,e.right=this.sourceRegion_.right)}},{key:"constrainToRegion_",value:function(e){var i=this.constrain;i&&(t.core.isFunction(i)?t.object.mixin(e,i(e)):(t.core.isElement(i)&&(i=p["default"].getRegion(i,!0)),e.left<i.left?e.left=i.left:e.right>i.right&&(e.left-=e.right-i.right),e.top<i.top?e.top=i.top:e.bottom>i.bottom&&(e.top-=e.bottom-i.bottom),e.right=e.left+e.width,e.bottom=e.top+e.height))}},{key:"constrainToSteps_",value:function(e){var t=e.left-this.sourceRegion_.left,i=e.top-this.sourceRegion_.top;e.left-=t%this.steps.x,e.right=e.left+e.width,e.top-=i%this.steps.y,e.bottom=e.top+e.height}},{key:"createActiveDragPlaceholder_",value:function(){var e=this.dragPlaceholder;e===i.Placeholder.CLONE?this.activeDragPlaceholder_=this.cloneActiveDrag_():t.core.isElement(e)?this.activeDragPlaceholder_=e:this.activeDragPlaceholder_=this.activeDragSource_}},{key:"defaultDragFn_",value:function(){this.moveToPosition_(this.activeDragPlaceholder_)}},{key:"defaultEndFn_",value:function(){this.moveToPosition_(this.activeDragSource_)}},{key:"disposeInternal",value:function(){this.cleanUpAfterDragging_(),this.dragHandler_=null,this.dragScrollDelta_.dispose(),this.dragScrollDelta_=null,this.sourceHandler_.removeAllListeners(),this.sourceHandler_=null,m(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"disposeInternal",this).call(this)}},{key:"getActiveDrag",value:function(){return this.activeDragSource_}},{key:"handleDragEndEvent_",value:function(){this.autoScroll&&this.autoScroll.stop(),this.dragScrollDelta_.stop(),f["default"].hideDocShim(),this.emit(i.Events.END,this.buildEventObject_()),this.cleanUpAfterDragging_()}},{key:"handleDragMoveEvent_",value:function(e){var t=e.targetTouches?e.targetTouches[0]:e,i=t.clientX-this.mousePos_.x,o=t.clientY-this.mousePos_.y;this.mousePos_.x=t.clientX,this.mousePos_.y=t.clientY,(this.isDragging()||this.hasReachedMinimumDistance_(i,o))&&(this.isDragging()||(this.startDragging_(e),this.dragScrollDelta_.start(this.activeDragPlaceholder_,this.scrollContainers)),this.autoScroll&&this.autoScroll.scroll(this.scrollContainers,this.mousePos_.x,this.mousePos_.y),this.updatePositionFromMouse())}},{key:"handleDragStartEvent_",value:function(e){this.activeDragSource_=e.delegateTarget||e.currentTarget,this.canStartDrag_(e)&&(this.calculateInitialPosition_(e.targetTouches?e.targetTouches[0]:e),e.preventDefault(),"keydown"===e.type?this.startDragging_(e):(this.dragHandler_.add.apply(this.dragHandler_,f["default"].attachDocListeners(this.useShim,{mousemove:this.handleDragMoveEvent_.bind(this),touchmove:this.handleDragMoveEvent_.bind(this),mouseup:this.handleDragEndEvent_.bind(this),touchend:this.handleDragEndEvent_.bind(this)})),this.distanceDragged_=0))}},{key:"handleKeyDown_",value:function(e){27===e.keyCode&&this.isDragging()&&this.handleDragEndEvent_()}},{key:"handleScrollDelta_",value:function(e){this.mouseSourceDelta_.x+=e.deltaX,this.mouseSourceDelta_.y+=e.deltaY,this.updatePositionFromMouse()}},{key:"handleSourceKeyDown_",value:function(e){if(this.isDragging()){var t=e.delegateTarget||e.currentTarget;if(t!==this.activeDragSource_)return;if(e.keyCode>=37&&e.keyCode<=40){var i=0,o=0,r=this.keyboardSpeed>=this.steps.x?this.keyboardSpeed:this.steps.x,a=this.keyboardSpeed>=this.steps.y?this.keyboardSpeed:this.steps.y;37===e.keyCode?i-=r:38===e.keyCode?o-=a:39===e.keyCode?i+=r:o+=a,this.updatePositionFromDelta(i,o),e.preventDefault()}else 13!==e.keyCode&&32!==e.keyCode&&27!==e.keyCode||this.handleDragEndEvent_()}else 13!==e.keyCode&&32!==e.keyCode||this.handleDragStartEvent_(e)}},{key:"handleContainerChanged_",value:function(){t.core.isString(this.sources)&&(this.sourceHandler_.removeAllListeners(),this.attachSourceEvents_()),this.prevScrollContainersSelector_&&(this.scrollContainers=this.prevScrollContainersSelector_)}},{key:"handleSourcesChanged_",value:function(){this.sourceHandler_.removeAllListeners(),this.attachSourceEvents_()}},{key:"hasReachedMinimumDistance_",value:function(e,t){return this.distanceDragged_+=Math.abs(e)+Math.abs(t),this.distanceDragged_>=this.minimumDragDistance}},{key:"isDragging",value:function(){return this.dragging_}},{key:"isWithinHandle_",value:function(e){var i=this.handles;return!i||(t.core.isString(i)?g["default"].match(e,i+", "+i+" *"):g["default"].contains(i,e))}},{key:"moveToPosition_",value:function(e){e.style.left=this.sourceRelativePos_.x+"px",e.style.top=this.sourceRelativePos_.y+"px"}},{key:"setterAutoScrollFn_",value:function(e){if(e!==!1)return new _["default"](e)}},{key:"setterConstrainFn",value:function(e){return t.core.isString(e)&&(e=g["default"].toElement(e)),e}},{key:"setterScrollContainersFn_",value:function(e){this.prevScrollContainersSelector_=t.core.isString(e)?e:null;var i=this.toElements_(e);return i.push(document),i}},{key:"startDragging_",value:function(e){this.dragging_=!0,this.createActiveDragPlaceholder_(),g["default"].addClasses(this.activeDragPlaceholder_,this.draggingClass),this.activeDragPlaceholder_.setAttribute("aria-grabbed","true"),this.emit(i.Events.START,{originalEvent:e})}},{key:"toElements_",value:function(e){if(t.core.isString(e)){var i=this.container.querySelectorAll(e);return Array.prototype.slice.call(i,0)}return e?[e]:[]}},{key:"updatePosition",value:function(e){this.constrain_(e);var t=e.left-this.sourceRegion_.left,o=e.top-this.sourceRegion_.top;0===t&&0===o||(this.sourceRegion_=e,this.sourceRelativePos_.x+=t,this.sourceRelativePos_.y+=o,this.emit(i.Events.DRAG,this.buildEventObject_()))}},{key:"updatePositionFromDelta",value:function(e,i){var o=t.object.mixin({},this.sourceRegion_);o.left+=e,o.right+=e,o.top+=i,o.bottom+=i,this.updatePosition(o)}},{key:"updatePositionFromMouse",value:function(){var e={height:this.sourceRegion_.height,left:this.mousePos_.x+this.mouseSourceDelta_.x,top:this.mousePos_.y+this.mouseSourceDelta_.y,width:this.sourceRegion_.width};e.right=e.left+e.width,e.bottom=e.top+e.height,this.updatePosition(e)}},{key:"validateElementOrString_",value:function(e){return t.core.isString(e)||t.core.isElement(e)}},{key:"validatorConstrainFn",value:function(e){return t.core.isString(e)||t.core.isObject(e)}}]),i}(y["default"]);S.STATE={autoScroll:{setter:"setterAutoScrollFn_",value:!1,writeOnce:!0},axis:{validator:t.core.isString},constrain:{setter:"setterConstrainFn",validator:"validatorConstrainFn"},container:{setter:g["default"].toElement,validator:"validateElementOrString_",value:document},disabled:{validator:t.core.isBoolean,value:!1},draggingClass:{validator:t.core.isString,value:"dragging"},dragPlaceholder:{validator:"validateElementOrString_"},handles:{validator:"validateElementOrString_"},keyboardSpeed:{validator:t.core.isNumber,value:10},minimumDragDistance:{validator:t.core.isNumber,value:5,writeOnce:!0},scrollContainers:{setter:"setterScrollContainersFn_",validator:"validateElementOrString_"},sources:{validator:"validateElementOrString_"},steps:{validator:t.core.isObject,valueFn:function(){return{x:1,y:1}}},useShim:{value:!0}},S.Events={DRAG:"drag",END:"end",START:"start"},S.Placeholder={CLONE:"clone"},e["default"]=S});