define(["exports","metal/src/metal","metal-dom/src/all/dom","metal-component/src/all/component","./IncrementalDomAop","./children/IncrementalDomChildren","./cleanup/IncrementalDomUnusedComponents","./utils/IncrementalDomUtils","./incremental-dom"],function(e,t,n,r,o,a,i,l){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}function d(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function h(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(e,"__esModule",{value:!0});var p=s(n),_=s(o),m=s(a),f=s(i),g=s(l),C=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),v=function R(e,t,n){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,t);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:R(o,t,n)}if("value"in r)return r.value;var a=r.get;if(void 0!==a)return a.call(n)},y=function(e){function o(e){c(this,o);var t=u(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));return e.context={},e.refs={},t.config_=e.getInitialConfig(),t.childComponents_=[],t.clearChanges_(),e.on("attached",t.handleAttached_.bind(t)),t.handleInterceptedAttributesCall_=t.handleInterceptedAttributesCall_.bind(t),t.handleInterceptedCloseCall_=t.handleInterceptedCloseCall_.bind(t),t.handleInterceptedOpenCall_=t.handleInterceptedOpenCall_.bind(t),t.handleChildrenCaptured_=t.handleChildrenCaptured_.bind(t),t.handleChildRender_=t.handleChildRender_.bind(t),t.renderInsidePatchDontSkip_=t.renderInsidePatchDontSkip_.bind(t),t}return h(o,e),C(o,[{key:"addElementClasses_",value:function(e,t){for(var n=3;n<t.length;n+=2)if("class"===t[n])return void(t[n+1]=this.removeDuplicateClasses_(t[n+1]+" "+e));for(;t.length<3;)t.push(null);t.push("class",e)}},{key:"attachDecoratedListeners_",value:function(e,t){if(!this.component_.wasRendered)for(var n=(t[2]||[]).concat(t.slice(3)),r=0;r<n.length;r+=2){var o=this.getEventFromListenerAttr_(n[r]);o&&!e[o+"__handle__"]&&this.attachEvent_(e,n[r],o,n[r+1])}}},{key:"attachEvent_",value:function(e,n,r,o){var a=r+"__handle__";e[a]&&(e[a].removeListener(),e[a]=null),e[n]=o,o?(t.core.isString(o)&&("d"===n[0]&&e.setAttribute(n,o),o=this.component_.getListenerFn(o)),e[a]=p["default"].delegate(document,r,e,o)):e.removeAttribute(n)}},{key:"buildChildren_",value:function(e){return 0===e.length?D:e}},{key:"buildShouldUpdateArgs_",value:function(){return[this.changes_]}},{key:"clearChanges_",value:function(){this.changes_={}}},{key:"disposeInternal",value:function(){v(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"disposeInternal",this).call(this);var e=this.component_,t=this.config_.ref,n=this.getOwner();n&&n.components&&n.components[t]===e&&delete n.components[t];for(var r=0;r<this.childComponents_.length;r++){var a=this.childComponents_[r];a.isDisposed()||(a.element=null,a.dispose())}this.childComponents_=null}},{key:"getEventFromListenerAttr_",value:function(e){var t=o.LISTENER_REGEX.exec(e),n=t?t[1]?t[1]:t[2]:null;return n?n.toLowerCase():null}},{key:"getOwner",value:function(){return this.owner_}},{key:"getParent",value:function(){return this.parent_}},{key:"getSubComponent_",value:function(e,n){var a=e;t.core.isString(a)&&(a=r.ComponentRegistry.getConstructor(e));var i,l=o.getCurrentData();if(t.core.isDef(n.ref))i=this.match_(this.component_.components[n.ref],a,n),this.component_.addSubComponent(n.ref,i),this.component_.refs[n.ref]=i;else if(t.core.isDef(n.key))i=this.match_(l.prevComps.keys[n.key],a,n),l.currComps.keys[n.key]=i;else{var s=t.core.getUid(a,!0);l.currComps.order[s]=l.currComps.order[s]||[];var d=l.currComps.order[s];i=this.match_((l.prevComps.order[s]||[])[d.length],a,n),d.push(i)}return i}},{key:"guaranteeParent_",value:function(){var e=this.component_.element;if(!e||!e.parentNode){var t=document.createElement("div");return e&&p["default"].append(t,e),t}}},{key:"handleAttached_",value:function(e){this.attachData_=e}},{key:"handleChildrenCaptured_",value:function(e){var t=this.componentToRender_,n=t.props,r=t.tag;n.children=this.buildChildren_(e.props.children),this.componentToRender_=null,this.renderFromTag_(r,n)}},{key:"handleChildRender_",value:function(e){if(e.tag&&g["default"].isComponentTag(e.tag))return e.props.children=this.buildChildren_(e.props.children),this.renderFromTag_(e.tag,e.props),!0}},{key:"handleDataManagerCreated_",value:function(){v(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"handleDataManagerCreated_",this).call(this);var e=this.component_.getDataManager();this.component_.constructor.SYNC_UPDATES_MERGED||e.on("dataPropChanged",this.handleDataPropChanged_.bind(this)),e.add("children",{validator:Array.isArray,value:D},this.config_.children||D)}},{key:"handleDataPropChanged_",value:function(e){this.changes_[e.key]=e}},{key:"handleInterceptedAttributesCall_",value:function(e,n,r,o){var a=this.getEventFromListenerAttr_(r);return a?void this.attachEvent_(n,r,a,o):("checked"===r&&(o=t.core.isDefAndNotNull(o)&&o!==!1),"value"===r&&n.value!==o&&(n[r]=o),void(t.core.isBoolean(o)?(n[r]=o,o?n.setAttribute(r,""):n.removeAttribute(r)):e(n,r,o)))}},{key:"handleInterceptedCloseCall_",value:function(e,t){this.emit(o.ELEMENT_CLOSED,{tag:t});var r=e(t);return this.resetData_(n.domData.get(r).incDomData_),r}},{key:"handleInterceptedOpenCall_",value:function(e,t){return g["default"].isComponentTag(t)?this.handleSubComponentCall_.apply(this,arguments):this.handleRegularCall_.apply(this,arguments)}},{key:"handleManagerDataPropChanged_",value:function(e){this.handleDataPropChanged_(e),v(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"handleManagerDataPropChanged_",this).call(this,e)}},{key:"handleRegularCall_",value:function(e){for(var n=arguments.length,r=Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];this.emit(o.ELEMENT_OPENED,{args:r});var i=o.getComponentBeingRendered(),l=i.getRenderer();if(!l.rootElementReached_){l.config_.key&&(r[1]=l.config_.key);var s=i.getDataManager().get("elementClasses");s&&this.addElementClasses_(s,r)}var d=e.apply(null,r);this.attachDecoratedListeners_(d,r),this.updateElementIfNotReached_(d);var c=g["default"].buildConfigFromCall(r);return t.core.isDefAndNotNull(c.ref)&&(this.component_.refs[c.ref]=d),d}},{key:"handleSubComponentCall_",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var o=g["default"].buildConfigFromCall(n);this.componentToRender_={props:o,tag:n[0]},m["default"].capture(this,this.handleChildrenCaptured_)}},{key:"hasDataChanged_",value:function(){return Object.keys(this.changes_).length>0}},{key:"intercept_",value:function(){_["default"].startInterception({attributes:this.handleInterceptedAttributesCall_,elementClose:this.handleInterceptedCloseCall_,elementOpen:this.handleInterceptedOpenCall_})}},{key:"match_",value:function(e,t,n){return e&&e.constructor===t||(e=new t(n,(!1))),e.wasRendered&&(e.getRenderer().startSkipUpdates(),e.getDataManager().replaceNonInternal(n),e.getRenderer().stopSkipUpdates()),e.getRenderer().config_=n,e}},{key:"patch",value:function(){if(!this.component_.element&&this.parent_)return void this.parent_.getRenderer().patch();var e=this.guaranteeParent_();if(e)IncrementalDOM.patch(e,this.renderInsidePatchDontSkip_),p["default"].exitDocument(this.component_.element),this.component_.element&&this.component_.inDocument&&this.component_.renderElement_(this.attachData_.parent,this.attachData_.sibling);else{var t=this.component_.element;IncrementalDOM.patchOuter(t,this.renderInsidePatchDontSkip_),this.component_.element||p["default"].exitDocument(t)}}},{key:"removeDuplicateClasses_",value:function(e){for(var t=[],n=e.split(/\s+/),r={},o=0;o<n.length;o++)r[n[o]]||(r[n[o]]=!0,t.push(n[o]));return t.join(" ")}},{key:"render",value:function(){this.patch()}},{key:"renderChild",value:function(e){this.intercept_(),m["default"].render(e,this.handleChildRender_),_["default"].stopInterception()}},{key:"renderFromTag_",value:function(e,n){if(t.core.isString(e)||e.prototype.getRenderer){var r=this.renderSubComponent_(e,n);return this.updateElementIfNotReached_(r.element),r.element}return e(n)}},{key:"renderIncDom",value:function(){this.component_.render?this.component_.render():IncrementalDOM.elementVoid("div")}},{key:"renderInsidePatch",value:function(){return this.component_.wasRendered&&!this.shouldUpdate()&&IncrementalDOM.currentPointer()===this.component_.element?void(this.component_.element&&IncrementalDOM.skipNode()):void this.renderInsidePatchDontSkip_()}},{key:"renderInsidePatchDontSkip_",value:function(){o.startedRenderingComponent(this.component_),this.clearChanges_(),this.rootElementReached_=!1,f["default"].schedule(this.childComponents_),this.childComponents_=[],this.component_.refs={},this.intercept_(),this.renderIncDom(),_["default"].stopInterception(),this.rootElementReached_||(this.component_.element=null),this.emit("rendered",!this.isRendered_),o.finishedRenderingComponent(),this.resetData_(this.incDomData_)}},{key:"renderSubComponent_",value:function(e,t){var n=this.getSubComponent_(e,t);this.updateContext_(n);var r=n.getRenderer();if(r instanceof o){var a=o.getComponentBeingRendered();a.getRenderer().childComponents_.push(n),r.parent_=a,r.owner_=this.component_,r.renderInsidePatch()}return n.wasRendered||n.renderAsSubComponent(),n}},{key:"resetData_",value:function(e){e&&(e.prevComps.keys=e.currComps.keys,e.prevComps.order=e.currComps.order,e.currComps.keys={},e.currComps.order={})}},{key:"shouldUpdate",value:function(){if(!this.hasDataChanged_())return!1;if(this.component_.shouldUpdate){var e;return(e=this.component_).shouldUpdate.apply(e,d(this.buildShouldUpdateArgs_()))}return!0}},{key:"skipNextChildrenDisposal",value:function(){this.childComponents_=[]}},{key:"update",value:function(){this.shouldUpdate()&&this.patch()}},{key:"updateElementIfNotReached_",value:function(e){var t=o.getComponentBeingRendered(),n=t.getRenderer();n.rootElementReached_||(n.rootElementReached_=!0,t.element!==e&&(t.element=e))}},{key:"updateContext_",value:function(e){var n=e.context,r=o.getComponentBeingRendered(),a=r.getChildContext?r.getChildContext():{};t.object.mixin(n,r.context,a),e.context=n}}],[{key:"finishedRenderingComponent",value:function(){k.pop(),0===k.length&&f["default"].disposeUnused()}},{key:"getComponentBeingRendered",value:function(){return k[k.length-1]}},{key:"getCurrentData",value:function(){var e=IncrementalDOM.currentElement(),t=o.getComponentBeingRendered(),r=t.getRenderer(),a=r;return r.rootElementReached_&&e!==t.element.parentNode&&(a=n.domData.get(e)),a.incDomData_=a.incDomData_||{currComps:{keys:{},order:{}},prevComps:{keys:{},order:{}}},a.incDomData_}},{key:"isIncDomNode",value:function(e){return!!e[m["default"].CHILD_OWNER]}},{key:"render",value:function(e,t,n){if(!r.Component.isComponentCtor(e)){var a=e,i=function(e){function t(){return c(this,t),u(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return h(t,e),C(t,[{key:"created",value:function(){o.getComponentBeingRendered()&&this.getRenderer().updateContext_(this)}},{key:"render",value:function(){a(this.getRenderer().config_)}}]),t}(r.Component);i.RENDERER=o,e=i}return r.Component.render(e,t,n)}},{key:"renderChild",value:function(e){e[m["default"].CHILD_OWNER].renderChild(e)}},{key:"startedRenderingComponent",value:function(e){k.push(e)}}]),o}(r.ComponentRenderer),k=[],D=[];y.ELEMENT_OPENED="elementOpened",y.ELEMENT_CLOSED="elementClosed",y.LISTENER_REGEX=/^(?:on([A-Z]\w+))|(?:data-on(\w+))$/,e["default"]=y});