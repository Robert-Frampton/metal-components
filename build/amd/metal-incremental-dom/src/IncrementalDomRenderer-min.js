define(["exports","metal/src/metal","metal-dom/src/all/dom","metal-component/src/all/component","./IncrementalDomAop","./incremental-dom"],function(e,t,n,o,r){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(e,"__esModule",{value:!0});var p=s(n),c=s(r),h=function(e){function n(t){i(this,n);var r=a(this,e.call(this,t));return r.changes_={},r.eventsCollector_=new o.EventsCollector(t),t.on("stateKeyChanged",r.handleStateKeyChanged_.bind(r)),t.on("detached",r.handleDetached_.bind(r)),r.handleInterceptedAttributesCall_=r.handleInterceptedAttributesCall_.bind(r),r.handleInterceptedOpenCall_=r.handleInterceptedOpenCall_.bind(r),r.handleInterceptedChildrenCloseCall_=r.handleInterceptedChildrenCloseCall_.bind(r),r.handleInterceptedChildrenOpenCall_=r.handleInterceptedChildrenOpenCall_.bind(r),r.handleInterceptedChildrenTextCall_=r.handleInterceptedChildrenTextCall_.bind(r),r.renderInsidePatchDontSkip_=r.renderInsidePatchDontSkip_.bind(r),r}return l(n,e),n.prototype.addInlineListeners_=function(e){for(var n=0;n<e.length;n+=2){var o=e[n],r=e[n+1];o.startsWith("data-on")&&t.core.isString(r)&&this.listenersToAttach_.push({eventName:o.substr(7),fn:r})}},n.prototype.attachInlineListeners_=function(){this.eventsCollector_.startCollecting();for(var e=0;e<this.listenersToAttach_.length;e++){var t=this.listenersToAttach_[e];this.eventsCollector_.attachListener(t.eventName,t.fn)}},n.prototype.buildChildrenFn_=function(e){var n=this;return function(){n.intercept_();for(var o=0;o<e.length;o++)IncrementalDOM[e[o].name].apply(null,t.array.slice(e[o].args,1));c["default"].stopInterception()}},n.prototype.disposeUnusedSubComponents_=function(){for(var e=Object.keys(this.component_.components),t=[],n=0;n<e.length;n++)this.subComponentsFound_[e[n]]||t.push(e[n]);this.component_.disposeSubComponents(t)},n.prototype.getSubComponent_=function(e,t,n){var o=this.component_.addSubComponent(e,t,n);return o.wasRendered&&o.setState(n),o},n.prototype.guaranteeParent_=function(){var e=this.component_.element;if(!e||!e.parentNode){var t=document.createElement("div");return e&&p["default"].append(t,e),t}},n.prototype.handleDetached_=function(){this.eventsCollector_.detachAllListeners()},n.prototype.handleInterceptedAttributesCall_=function(e,n,o,r){if(o.startsWith("data-on")){var s=o.substr(7);t.core.isFunction(n[o])&&n.removeEventListener(s,n[o]),t.core.isFunction(r)&&p["default"].on(n,s,r)}else"checked"===o&&(n.checked=t.core.isDefAndNotNull(r)&&r!==!1);e(n,o,r)},n.prototype.handleInterceptedChildrenCloseCall_=function(e,t){if(this.isCurrentComponentTag_(t)&&0===--this.componentToRender_.tagsCount){var n=this.componentToRender_,o=n.calls,r=n.config,s=n.tag;return r.children=this.buildChildrenFn_(o),this.componentToRender_=null,c["default"].stopInterception(),this.renderSubComponent_(s,r).element}this.componentToRender_.calls.push({name:"elementClose",args:arguments})},n.prototype.handleInterceptedChildrenOpenCall_=function(e,t){this.isCurrentComponentTag_(t)&&this.componentToRender_.tagsCount++,this.componentToRender_.calls.push({name:"elementOpen",args:arguments})},n.prototype.handleInterceptedChildrenTextCall_=function(){this.componentToRender_.calls.push({name:"text",args:arguments})},n.prototype.handleInterceptedOpenCall_=function(e,t){return this.isComponentTag_(t)?this.handleSubComponentCall_.apply(this,arguments):this.handleRegularCall_.apply(this,arguments)},n.prototype.handleRegularCall_=function(e,n,o,r){var s=t.array.slice(arguments,4);this.addInlineListeners_((r||[]).concat(s));var i=t.array.slice(arguments,1);!this.rootElementReached_&&this.component_.config.key&&(i[1]=this.component_.config.key);var a=e.apply(null,i);return this.rootElementReached_||(this.rootElementReached_=!0,this.component_.element!==a&&(this.component_.element=a),this.lastElementCreationCall_=i),a},n.prototype.handleStateKeyChanged_=function(e){this.changes_[e.key]=e},n.prototype.handleSubComponentCall_=function(e,n,o,r){for(var s={key:o},i=(r||[]).concat(t.array.slice(arguments,4)),a=0;a<i.length;a+=2)s[i[a]]=i[a+1];this.componentToRender_={calls:[],config:s,tag:n,tagsCount:1},c["default"].startInterception({elementClose:this.handleInterceptedChildrenCloseCall_,elementOpen:this.handleInterceptedChildrenOpenCall_,text:this.handleInterceptedChildrenTextCall_})},n.prototype.hasChangedBesidesElement_=function(){var e=Object.keys(this.changes_).length;return this.changes_.hasOwnProperty("element")&&e--,e>0},n.prototype.intercept_=function(){c["default"].startInterception({attributes:this.handleInterceptedAttributesCall_,elementOpen:this.handleInterceptedOpenCall_})},n.prototype.isComponentTag_=function(e){return!t.core.isString(e)||e[0]===e[0].toUpperCase()},n.prototype.isCurrentComponentTag_=function(e){return this.isComponentTag_(e)&&this.componentToRender_.tag===e},n.prototype.render=function(){this.patch()},n.prototype.renderIncDom=function(){IncrementalDOM.elementVoid("div")},n.prototype.renderInsidePatch=function(){return this.component_.wasRendered&&!this.shouldUpdate(this.changes_)?void this.skipRerender_():void this.renderInsidePatchDontSkip_()},n.prototype.renderInsidePatchDontSkip_=function(){this.changes_={},this.rootElementReached_=!1,this.subComponentsFound_={},this.generatedKeyCount_=0,this.listenersToAttach_=[],this.intercept_(),this.renderIncDom(),c["default"].stopInterception(),this.attachInlineListeners_(),this.emit("rendered",!this.component_.wasRendered)},n.prototype.renderSubComponent_=function(e,t){var o=t.key||"sub"+this.generatedKeyCount_++,r=this.getSubComponent_(o,e,t),s=r.getRenderer();return s instanceof n&&s.renderInsidePatch(),r.wasRendered||r.renderAsSubComponent(),this.subComponentsFound_[o]=!0,r},n.prototype.shouldUpdate=function(e){return this.component_.shouldUpdate?this.component_.shouldUpdate(e):!0},n.prototype.skipRerender_=function(){IncrementalDOM.elementOpen.apply(null,this.lastElementCreationCall_),IncrementalDOM.skip(),IncrementalDOM.elementClose(this.lastElementCreationCall_[0])},n.prototype.patch=function(){var e=this.guaranteeParent_();e?(IncrementalDOM.patch(e,this.renderInsidePatchDontSkip_),p["default"].exitDocument(this.component_.element)):IncrementalDOM.patchOuter(this.component_.element,this.renderInsidePatchDontSkip_)},n.prototype.update=function(){this.hasChangedBesidesElement_()&&this.shouldUpdate(this.changes_)&&(this.patch(),this.eventsCollector_.detachUnusedListeners(),this.disposeUnusedSubComponents_())},n}(o.ComponentRenderer);e["default"]=h});