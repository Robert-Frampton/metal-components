define(["exports","metal/src/metal","metal-dom/src/all/dom","./ComponentDataManager","./ComponentRenderer","metal-events/src/events"],function(e,t,n,r,o,s){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function c(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(e,"__esModule",{value:!0});var d=i(r),p=i(o),h=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=function(e){function r(n,o){a(this,r);var i=l(this,e.call(this));return i.attachedListeners_={},i.components={},i.elementEventProxy_=null,i.eventsStateKeyHandler_=new s.EventHandler,i.inDocument=!1,i.initialConfig_=n||{},i.wasRendered=!1,i.DEFAULT_ELEMENT_PARENT=document.body,t.core.mergeSuperClassesProperty(i.constructor,"ELEMENT_CLASSES",i.mergeElementClasses_),t.core.mergeSuperClassesProperty(i.constructor,"SYNC_UPDATES",t.array.firstDefinedValue),i.element=i.initialConfig_.element,i.dataManager_=i.createDataManager(),i.renderer_=i.createRenderer(),i.renderer_.on("rendered",i.handleRendererRendered_.bind(i)),i.on("stateChanged",i.handleStateChanged_),i.newListenerHandle_=i.on("newListener",i.handleNewListener_),i.on("eventsChanged",i.onEventsChanged_),i.addListenersFromObj_(i.dataManager_.get("events")),i.created(),i.componentCreated_=!0,o!==!1&&i.render_(o),i.on("elementChanged",i.onElementChanged_),i}return c(r,e),r.prototype.addElementClasses=function(){var e=this.constructor.ELEMENT_CLASSES_MERGED,t=this.dataManager_.get("elementClasses");t&&(e=e+" "+t),n.dom.addClasses(this.element,e)},r.prototype.addListenersFromObj_=function(e){for(var t=Object.keys(e||{}),n=0;n<t.length;n++){var r=this.extractListenerInfo_(e[t[n]]);if(r.fn){var o;o=r.selector?this.delegate(t[n],r.selector,r.fn):this.on(t[n],r.fn),this.eventsStateKeyHandler_.add(o)}}},r.prototype.attach=function(e,t){return this.inDocument||(this.renderElement_(e,t),this.inDocument=!0,this.emit("attached",{parent:e,sibling:t}),this.attached()),this},r.prototype.attached=function(){},r.prototype.addSubComponent=function(e,t){this.components[e]=t},r.prototype.created=function(){},r.prototype.createDataManager=function(){return t.core.mergeSuperClassesProperty(this.constructor,"DATA_MANAGER",t.array.firstDefinedValue),new this.constructor.DATA_MANAGER_MERGED(this,r.DATA)},r.prototype.createRenderer=function(){return t.core.mergeSuperClassesProperty(this.constructor,"RENDERER",t.array.firstDefinedValue),new this.constructor.RENDERER_MERGED(this)},r.prototype.delegate=function(e,t,n){return this.on("delegate:"+e+":"+t,n)},r.prototype.detach=function(){return this.inDocument&&(this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.inDocument=!1,this.detached()),this.emit("detached"),this},r.prototype.detached=function(){},r.prototype.disposed=function(){},r.prototype.disposeInternal=function(){this.disposed(),this.detach(),this.elementEventProxy_&&(this.elementEventProxy_.dispose(),this.elementEventProxy_=null),this.disposeSubComponents(Object.keys(this.components)),this.components=null,this.dataManager_.dispose(),this.dataManager_=null,this.renderer_.dispose(),this.renderer_=null,e.prototype.disposeInternal.call(this)},r.prototype.disposeSubComponents=function(e){for(var t=0;t<e.length;t++){var n=this.components[e[t]];n&&!n.isDisposed()&&(n.element=null,n.dispose(),delete this.components[e[t]])}},r.prototype.extractListenerInfo_=function(e){var n={fn:e};return t.core.isObject(e)&&!t.core.isFunction(e)&&(n.selector=e.selector,n.fn=e.fn),t.core.isString(n.fn)&&(n.fn=this.getListenerFn(n.fn)),n},r.prototype.getDataManager=function(){return this.dataManager_},r.prototype.getInitialConfig=function(){return this.initialConfig_},r.prototype.getListenerFn=function(e){if(t.core.isFunction(this[e]))return this[e].bind(this)},r.prototype.getState=function(){return this.dataManager_.getState()},r.prototype.getStateKeys=function(){return this.dataManager_.getStateKeys()},r.prototype.fireStateKeyChange_=function(e,n){var r=this["sync"+e.charAt(0).toUpperCase()+e.slice(1)];if(t.core.isFunction(r)){if(!n){var o=this.getDataManager();n={newVal:o.get(e),prevVal:void 0}}r.call(this,n.newVal,n.prevVal)}},r.prototype.getRenderer=function(){return this.renderer_},r.prototype.handleRendererRendered_=function(e){this.rendered(e),this.emit("rendered",e)},r.prototype.handleStateChanged_=function(e){this.syncStateFromChanges_(e.changes),this.emit("stateSynced",e)},r.prototype.handleNewListener_=function(e){this.attachedListeners_[e]=!0},r.isComponentCtor=function(e){return e.prototype&&e.prototype[r.COMPONENT_FLAG]},r.prototype.mergeElementClasses_=function(e){var t={};return e.filter(function(e){return!(!e||t[e])&&(t[e]=!0,!0)}).join(" ")},r.prototype.onElementChanged_=function(e){this.setUpProxy_(),this.elementEventProxy_.setOriginEmitter(e.newVal),e.newVal&&(this.addElementClasses(),this.syncVisible(this.dataManager_.get("visible")))},r.prototype.onEventsChanged_=function(e){this.eventsStateKeyHandler_.removeAllListeners(),this.addListenersFromObj_(e.newVal)},r.render=function(e,n,r){var o=n,s=r;t.core.isElement(n)&&(o=null,s=n);var i=new e(o,(!1));return i.render_(s),i},r.prototype.render_=function(e,t){t||this.emit("render"),this.setUpProxy_(),this.syncState_(),this.attach(e),this.wasRendered=!0},r.prototype.renderAsSubComponent=function(){this.render_(null,!0)},r.prototype.renderElement_=function(e,t){var r=this.element;if(r&&(t||!r.parentNode)){var o=n.dom.toElement(e)||this.DEFAULT_ELEMENT_PARENT;o.insertBefore(r,n.dom.toElement(t))}},r.prototype.setState=function(e,t){this.dataManager_.setState(e,t)},r.prototype.setUpProxy_=function(){if(!this.elementEventProxy_){var e=new n.DomEventEmitterProxy(this.element,this);this.elementEventProxy_=e,t.object.map(this.attachedListeners_,e.proxyEvent.bind(e)),this.attachedListeners_=null,this.newListenerHandle_.removeListener(),this.newListenerHandle_=null}},r.prototype.syncState_=function(){for(var e=this.dataManager_.getSyncKeys(),t=0;t<e.length;t++)this.fireStateKeyChange_(e[t])},r.prototype.syncStateFromChanges_=function(e){for(var t in e)this.fireStateKeyChange_(t,e[t])},r.prototype.syncElementClasses=function(e,t){this.element&&t&&n.dom.removeClasses(this.element,t),this.addElementClasses()},r.prototype.syncVisible=function(e){this.element&&(this.element.style.display=e?"":"none")},r.prototype.rendered=function(){},r.prototype.validatorElementClassesFn_=function(e){return t.core.isString(e)},r.prototype.validatorEventsFn_=function(e){return!t.core.isDefAndNotNull(e)||t.core.isObject(e)},h(r,[{key:"element",get:function(){return this.elementVal_},set:function(e){if((t.core.isElement(e)||t.core.isString(e)||!t.core.isDefAndNotNull(e))&&(e&&(e=n.dom.toElement(e)||this.elementVal_),this.elementVal_!==e)){var r=this.elementVal_;this.elementVal_=e,this.componentCreated_&&this.emit("elementChanged",{prevVal:r,newVal:e})}}}]),r}(s.EventEmitter);u.DATA={elementClasses:{validator:"validatorElementClassesFn_"},events:{validator:"validatorEventsFn_",value:null},visible:{validator:t.core.isBoolean,value:!0}},u.COMPONENT_FLAG="__metal_component__",u.DATA_MANAGER=d["default"],u.ELEMENT_CLASSES="",u.RENDERER=p["default"],u.SYNC_UPDATES=!1,u.prototype[u.COMPONENT_FLAG]=!0,e["default"]=u});